<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Zueschos Cover Creator</title>
    <meta name="description" content="Create custom Blu-ray covers easily. Upload your poster and get a perfect 3D case render.">
    <meta name="author" content="Zuescho">
    
    <meta property="og:title" content="Zueschos Cover Creator">
    <meta property="og:description" content="Create custom Blu-ray covers easily.">
    <meta property="og:url" content="https://zuescho.de/cover-creator">
    <meta property="og:type" content="website">

    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --accent: #c2185b; --text: #e0e0e0; --link: #ff4081; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        
        /* HEADER */
        header { width: 100%; max-width: 1200px; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 1px; font-weight: 300; display: flex; align-items: center; gap: 10px; }
        h1 span { font-weight: bold; color: var(--accent); }
        .version-tag { font-size: 0.7rem; background: #333; padding: 2px 6px; border-radius: 4px; color: #888; font-weight: normal; vertical-align: middle; }
        
        .home-link { color: var(--text); text-decoration: none; font-size: 0.9rem; opacity: 0.7; transition: 0.2s; border: 1px solid #444; padding: 5px 10px; border-radius: 4px; }
        .home-link:hover { opacity: 1; border-color: #777; }

        /* MAIN LAYOUT */
        .main-ui { display: flex; flex-wrap: wrap; gap: 30px; max-width: 1200px; width: 100%; justify-content: center; padding: 20px; flex-grow: 1; }
        .panel { background: var(--panel); padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 320px; display: flex; flex-direction: column; gap: 15px; height: fit-content; }
        
        .canvas-container { 
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABh0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMC41ZY743QAAABhJREFUOE9jBP7///8/AxD4//8/FAxjAAACQU/0f6b7rQAAAABJRU5ErkJggg=='); 
            padding: 10px; border-radius: 8px; border: 1px solid #333; position: relative;
        }
        canvas { display: block; max-width: 100%; height: auto; }

        h2 { margin: 0 0 5px 0; font-size: 1.1em; border-bottom: 2px solid var(--accent); padding-bottom: 5px; color: white; }
        label { font-size: 0.9em; color: #aaa; margin-bottom: 5px; display: block; font-weight: bold; }
        p { margin: 0; font-size: 0.85em; color: #777; line-height: 1.4; }
        
        input[type="file"] { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; box-sizing: border-box; }
        
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 1rem; transition: 0.2s; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button.download { background: #388e3c; }

        .status-box { background: #252526; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.8em; border-left: 3px solid #666; }
        .status-ok { border-color: #4caf50; color: #a5d6a7; }
        .status-err { border-color: #f44336; color: #ef9a9a; }
        .status-info { border-color: #2979ff; color: #90caf9; }

        /* FOOTER */
        footer { margin-top: 40px; padding: 20px; text-align: center; font-size: 0.8rem; color: #666; border-top: 1px solid #333; width: 100%; max-width: 1200px; }
        footer a { color: var(--link); text-decoration: none; transition: 0.2s; }
        footer a:hover { text-decoration: underline; color: #fff; }

    </style>
</head>
<body>

    <header>
        <h1><span>Zueschos</span> Cover Creator <div class="version-tag">v1.0</div></h1>
        <a href="https://zuescho.de" class="home-link">← Back to zuescho.de</a>
    </header>

    <div class="main-ui">
        <div class="panel">
            <h2>1. Upload Poster</h2>
            <p>Simply upload your movie poster. The app uses the <code>mask.png</code> on the server to apply the correct shape automatically.</p>
            
            <label style="margin-top: 15px;">Select Image File</label>
            <input type="file" id="posterInput" accept="image/*">
            
            <div id="statusArea" class="status-box status-info" style="margin-top: 15px;">
                Initializing system...
            </div>
            
            <div style="margin-top: auto;">
                <label>System Info</label>
                <div id="debugInfo" style="font-size: 0.8em; color: #555;">Waiting for assets...</div>
            </div>
        </div>

        <div class="panel" style="width: auto; align-items: center;">
            <h2>2. Preview</h2>
            <div class="canvas-container">
                <canvas id="canvas" width="512" height="512"></canvas>
            </div>
            <button class="download" onclick="downloadCover()">⬇ Download poster.png</button>
        </div>
    </div>

    <footer>
        <p>
            Created by <b>Zuescho</b> with the help of <b>Gemini AI</b>.
        </p>
        <p>
            Inspired by <a href="https://github.com/omegas82128/Aikino" target="_blank">Aikino</a>.
        </p>
        <p>
            Blu-ray Case Template by <a href="https://www.deviantart.com/920r9/art/DVD-Plastic-Case-for-GIMP-106113654" target="_blank">920r9 (DeviantArt)</a>.
        </p>
    </footer>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('statusArea');
        const debugEl = document.getElementById('debugInfo');

        // STATE
        const ASSETS = {
            'mask':   { src: 'assets/mask.png', img: null },
            'case':   { src: 'assets/case.png', img: null },
            'shadow': { src: 'assets/shadow.png', img: null },
            'clips':  { src: 'assets/clips.png', img: null },
            'lights': { src: 'assets/lights.png', img: null }
        };

        // This will hold the "Blue Area" coordinates found inside mask.png
        let MASK_ZONE = { x: 0, y: 0, w: 512, h: 512, valid: false };
        let currentPoster = null;

        // --- 1. INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', async () => {
            log("Loading server assets...", "status-info");
            
            try {
                // Load all images in parallel
                const promises = Object.keys(ASSETS).map(key => loadAsset(ASSETS[key].src).then(img => ASSETS[key].img = img));
                await Promise.all(promises);
                
                // ANALYZE THE MASK
                if (ASSETS.mask.img) {
                    analyzeMask(ASSETS.mask.img);
                } else {
                    log("Error: 'assets/mask.png' missing.", "status-err");
                }
                
                // Initial Draw
                render();

            } catch (e) {
                console.error(e);
                log("Error loading assets.", "status-err");
            }
            
            // Poster Listener
            document.getElementById('posterInput').addEventListener('change', handlePosterUpload);
        });

        // --- 2. THE MAGIC: SCANNING THE MASK ---
        function analyzeMask(img) {
            // Create a temporary canvas to read pixels
            const tempC = document.createElement('canvas');
            tempC.width = 512;
            tempC.height = 512;
            const tCtx = tempC.getContext('2d');
            tCtx.drawImage(img, 0, 0);
            
            // Get pixel data
            const p = tCtx.getImageData(0, 0, 512, 512).data;
            
            let minX = 512, minY = 512, maxX = 0, maxY = 0;
            let found = false;

            // Loop through every pixel
            for (let y = 0; y < 512; y++) {
                for (let x = 0; x < 512; x++) {
                    const alpha = p[(y * 512 + x) * 4 + 3];
                    if (alpha > 20) { // If pixel is not transparent
                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;
                        found = true;
                    }
                }
            }

            if (found) {
                MASK_ZONE = {
                    x: minX,
                    y: minY,
                    w: maxX - minX,
                    h: maxY - minY,
                    valid: true
                };
                log("Ready! Upload a poster.", "status-ok");
                debugEl.innerHTML = `Mask Area: X:${MASK_ZONE.x} Y:${MASK_ZONE.y} (${MASK_ZONE.w}x${MASK_ZONE.h})`;
            } else {
                log("Error: mask.png is empty!", "status-err");
            }
        }

        // --- 3. RENDERING ---
        function render() {
            ctx.clearRect(0, 0, 512, 512);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // -- A. DRAW MASK LAYER --
            if (ASSETS.mask.img) {
                ctx.drawImage(ASSETS.mask.img, 0, 0);
                // "source-in" = Keep only pixels that overlap with the mask
                ctx.globalCompositeOperation = 'source-in';
            }

            // -- B. DRAW POSTER (Auto-Fitted) --
            if (currentPoster && MASK_ZONE.valid) {
                const drawRect = calculateFit(currentPoster, MASK_ZONE);
                ctx.drawImage(currentPoster, drawRect.x, drawRect.y, drawRect.w, drawRect.h);
            } else if (!currentPoster) {
                // Background color if no poster
                ctx.fillStyle = "#222";
                ctx.fillRect(0, 0, 512, 512);
            }

            // -- C. DRAW OVERLAYS --
            ctx.globalCompositeOperation = 'source-over';
            
            if (ASSETS.case.img)   ctx.drawImage(ASSETS.case.img, 0, 0);
            if (ASSETS.shadow.img) ctx.drawImage(ASSETS.shadow.img, 0, 0);
            if (ASSETS.clips.img)  ctx.drawImage(ASSETS.clips.img, 0, 0);
            if (ASSETS.lights.img) ctx.drawImage(ASSETS.lights.img, 0, 0);
        }

        // --- 4. UTILITIES ---
        function calculateFit(img, zone) {
            // "Cover" logic: Scale image to fill the zone completely
            const imgRatio = img.naturalWidth / img.naturalHeight;
            const zoneRatio = zone.w / zone.h;
            
            let newW, newH;

            if (imgRatio > zoneRatio) {
                newH = zone.h;
                newW = newH * imgRatio;
            } else {
                newW = zone.w;
                newH = newW / imgRatio;
            }
            
            // Center it
            const newX = zone.x - (newW - zone.w) / 2;
            const newY = zone.y - (newH - zone.h) / 2;

            return { x: newX, y: newY, w: newW, h: newH };
        }

        function handlePosterUpload(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        currentPoster = img;
                        log("Poster applied successfully.", "status-ok");
                        render();
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        }

        function downloadCover() {
            try {
                const link = document.createElement('a');
                link.download = 'poster.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (e) {
                alert("Browser blocked auto-download.\nPlease Right-Click the image -> Save Image As.");
            }
        }

        function loadAsset(src) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = src;
            });
        }

        function log(msg, cls) {
            statusEl.textContent = msg;
            statusEl.className = "status-box " + cls;
        }
    </script>
</body>
</html>