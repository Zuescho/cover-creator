<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Zueschos Cover Creator</title>
    <meta name="description" content="Create custom Blu-ray covers easily.">
    <meta name="author" content="Zuescho">
    
    <meta property="og:title" content="Zueschos Cover Creator">
    <meta property="og:url" content="https://zuescho.de/cover">
    <meta property="og:type" content="website">

    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --accent: #c2185b; --text: #e0e0e0; --link: #ff4081; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        
        header { width: 100%; max-width: 1200px; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 1px; font-weight: 300; display: flex; align-items: center; gap: 10px; }
        h1 span { font-weight: bold; color: var(--accent); }
        .version-tag { font-size: 0.7rem; background: #333; padding: 2px 6px; border-radius: 4px; color: #888; font-weight: normal; vertical-align: middle; }
        .home-link { color: var(--text); text-decoration: none; font-size: 0.9rem; opacity: 0.7; transition: 0.2s; border: 1px solid #444; padding: 5px 10px; border-radius: 4px; }
        .home-link:hover { opacity: 1; border-color: #777; }

        .main-ui { display: flex; flex-wrap: wrap; gap: 30px; max-width: 1200px; width: 100%; justify-content: center; padding: 20px; flex-grow: 1; }
        .panel { background: var(--panel); padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 320px; display: flex; flex-direction: column; gap: 15px; height: fit-content; }
        
        .canvas-container { 
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABh0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMC41ZY743QAAABhJREFUOE9jBP7///8/AxD4//8/FAxjAAACQU/0f6b7rQAAAABJRU5ErkJggg=='); 
            padding: 10px; border-radius: 8px; border: 1px solid #333; position: relative;
        }
        canvas { display: block; max-width: 100%; height: auto; }

        h2 { margin: 0 0 5px 0; font-size: 1.1em; border-bottom: 2px solid var(--accent); padding-bottom: 5px; color: white; }
        label { font-size: 0.9em; color: #aaa; margin-bottom: 5px; display: block; font-weight: bold; }
        p { margin: 0; font-size: 0.85em; color: #777; line-height: 1.4; }
        
        input[type="file"] { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; box-sizing: border-box; }
        
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 1rem; transition: 0.2s; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button.download { background: #388e3c; }

        .status-box { background: #252526; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.8em; border-left: 3px solid #666; }
        .status-ok { border-color: #4caf50; color: #a5d6a7; }
        .status-err { border-color: #f44336; color: #ef9a9a; }
        .status-info { border-color: #2979ff; color: #90caf9; }
        
        .toggle-row { display: flex; align-items: center; gap: 10px; background: #252526; padding: 10px; border-radius: 6px; margin-top: 5px; border: 1px solid #333; }
        .toggle-row input { width: auto; cursor: pointer; transform: scale(1.2); }
        .toggle-row label { margin: 0; cursor: pointer; color: #fff; }
        
        footer { margin-top: 40px; padding: 20px; text-align: center; font-size: 0.8rem; color: #666; border-top: 1px solid #333; width: 100%; max-width: 1200px; }
        footer a { color: var(--link); text-decoration: none; transition: 0.2s; }
        footer a:hover { text-decoration: underline; color: #fff; }
    </style>
</head>
<body>

    <header>
        <h1><span>Zueschos</span> Cover Creator <div class="version-tag">v1.3</div></h1>
        <a href="https://zuescho.de" class="home-link">← Back to zuescho.de</a>
    </header>

    <div class="main-ui">
        <div class="panel">
            <h2>1. Upload Poster</h2>
            <p>Select your image. The app automatically masks, resizes, and sharpens it.</p>
            
            <label style="margin-top: 15px;">Select Image File</label>
            <input type="file" id="posterInput" accept="image/*">
            
            <div style="margin-top: 15px;">
                <label>Quality Settings</label>
                <div class="toggle-row">
                    <input type="checkbox" id="hiresCheck" onchange="render()">
                    <label for="hiresCheck">High Res (1024px)</label>
                </div>
                <div class="toggle-row">
                    <input type="checkbox" id="sharpenCheck" checked onchange="render()">
                    <label for="sharpenCheck">Auto-Sharpen (Crisp Edges)</label>
                </div>
            </div>
            
            <div id="statusArea" class="status-box status-info" style="margin-top: 15px;">
                Initializing system...
            </div>
        </div>

        <div class="panel" style="width: auto; align-items: center;">
            <h2>2. Preview</h2>
            <div class="canvas-container">
                <canvas id="canvas" width="512" height="512"></canvas>
            </div>
            <button class="download" onclick="downloadCover()">⬇ Download poster.png</button>
        </div>
    </div>

    <footer>
        <p>Created by <b>Zuescho</b> with the help of <b>Gemini AI</b>.</p>
        <p>Blu-ray Case Template by <a href="https://www.deviantart.com/920r9/art/DVD-Plastic-Case-for-GIMP-106113654" target="_blank">920r9 (DeviantArt)</a>.</p>
        <p>Inspired by <a href="https://github.com/omegas82128/Aikino" target="_blank">Aikino</a>.</p>
    </footer>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('statusArea');
        const hiresCheck = document.getElementById('hiresCheck');
        const sharpenCheck = document.getElementById('sharpenCheck');

        // STATE
        const ASSETS = {
            'mask':   { src: 'assets/mask.png', img: null },
            'case':   { src: 'assets/case.png', img: null },
            'shadow': { src: 'assets/shadow.png', img: null },
            'clips':  { src: 'assets/clips.png', img: null },
            'lights': { src: 'assets/lights.png', img: null }
        };

        let MASK_ZONE = { x: 0, y: 0, w: 512, h: 512, valid: false };
        let currentPoster = null;

        // --- 1. INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', async () => {
            log("Loading server assets...", "status-info");
            try {
                const promises = Object.keys(ASSETS).map(key => loadAsset(ASSETS[key].src).then(img => ASSETS[key].img = img));
                await Promise.all(promises);
                
                if (ASSETS.mask.img) analyzeMask(ASSETS.mask.img);
                else log("Error: 'assets/mask.png' missing.", "status-err");
                
                render();
            } catch (e) {
                console.error(e);
                log("Error loading assets.", "status-err");
            }
            document.getElementById('posterInput').addEventListener('change', handlePosterUpload);
        });

        // --- 2. ANALYZE MASK ---
        function analyzeMask(img) {
            const tempC = document.createElement('canvas');
            tempC.width = 512;
            tempC.height = 512;
            const tCtx = tempC.getContext('2d');
            tCtx.drawImage(img, 0, 0);
            const p = tCtx.getImageData(0, 0, 512, 512).data;
            let minX = 512, minY = 512, maxX = 0, maxY = 0, found = false;

            for (let y = 0; y < 512; y++) {
                for (let x = 0; x < 512; x++) {
                    if (p[(y * 512 + x) * 4 + 3] > 20) {
                        if (x < minX) minX = x; if (x > maxX) maxX = x;
                        if (y < minY) minY = y; if (y > maxY) maxY = y;
                        found = true;
                    }
                }
            }
            if (found) {
                MASK_ZONE = { x: minX, y: minY, w: maxX - minX, h: maxY - minY, valid: true };
                log("Ready! Upload a poster.", "status-ok");
            } else {
                log("Error: mask.png is empty!", "status-err");
            }
        }

        // --- 3. SMART RESIZE (Stepped) ---
        function smartResize(img, targetW, targetH) {
            // If image is small enough, stick to basic resize
            if (img.width < targetW * 2) return img;

            // Step down by half until close to target
            let curCanvas = document.createElement('canvas');
            curCanvas.width = img.width;
            curCanvas.height = img.height;
            let curCtx = curCanvas.getContext('2d');
            curCtx.drawImage(img, 0, 0);

            let curW = img.width, curH = img.height;
            while (curW / 2 >= targetW) {
                let newW = Math.floor(curW / 2);
                let newH = Math.floor(curH / 2);
                let tempCanvas = document.createElement('canvas');
                tempCanvas.width = newW; tempCanvas.height = newH;
                let tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(curCanvas, 0, 0, newW, newH);
                curCanvas = tempCanvas;
                curW = newW; curH = newH;
            }
            return curCanvas;
        }

        // --- 4. SHARPEN FILTER ---
        function applySharpen(ctx, w, h, amount) {
            const imageData = ctx.getImageData(0, 0, w, h);
            const data = imageData.data;
            const width = imageData.width;
            const mix = amount || 0.05; // Strength

            // Very simple kernel [0, -1, 0, -1, 5, -1, 0, -1, 0]
            // We implement a weighted mix to prevent artifacts
            const output = new Uint8ClampedArray(data);
            
            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    const i = (y * width + x) * 4;
                    
                    // Simple cross kernel
                    const center = data[i];
                    const up = data[i - width * 4];
                    const down = data[i + width * 4];
                    const left = data[i - 4];
                    const right = data[i + 4];
                    
                    // Sharpen formula: Center + (Center - AverageNeighbors) * strength
                    // Optimized to: 5*Center - Up - Down - Left - Right ... mixed
                    
                    // Apply to RGB
                    for (let c = 0; c < 3; c++) {
                        const val = data[i + c];
                        const neighbors = data[i - width * 4 + c] + data[i + width * 4 + c] + data[i - 4 + c] + data[i + 4 + c];
                        const sharp = val * 5 - neighbors;
                        
                        // Blend original with sharp
                        output[i + c] = val + (sharp - val) * mix;
                    }
                    output[i+3] = data[i+3]; // Keep Alpha
                }
            }
            
            // Write back
            const finalData = new ImageData(output, w, h);
            ctx.putImageData(finalData, 0, 0);
        }

        // --- 5. RENDER ---
        function render() {
            const scale = hiresCheck.checked ? 2 : 1;
            const size = 512 * scale;
            
            canvas.width = size;
            canvas.height = size;
            
            ctx.clearRect(0, 0, size, size);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // SCALED ZONES
            const zone = {
                x: MASK_ZONE.x * scale, y: MASK_ZONE.y * scale,
                w: MASK_ZONE.w * scale, h: MASK_ZONE.h * scale
            };

            // A. DRAW MASK
            if (ASSETS.mask.img) {
                ctx.drawImage(ASSETS.mask.img, 0, 0, size, size);
                ctx.globalCompositeOperation = 'source-in';
            }

            // B. DRAW POSTER
            if (currentPoster && MASK_ZONE.valid) {
                const fit = calculateFit(currentPoster, zone);
                
                // 1. Resize nicely
                const cleanPoster = smartResize(currentPoster, fit.w, fit.h);
                
                // 2. Draw to main canvas
                ctx.drawImage(cleanPoster, fit.x, fit.y, fit.w, fit.h);
                
                // 3. Apply Sharpen (if enabled)
                // We only sharpen the poster area to avoid messing up the transparent mask edges
                if (sharpenCheck.checked) {
                    // It's tricky to sharpen only the poster without affecting the mask alpha.
                    // So we sharpen the whole canvas *while inside source-in mode* (affecting only the opaque parts aka poster)
                    // Actually, 'source-in' is active. We are drawing on the mask.
                    applySharpen(ctx, size, size, 0.4); 
                }
            } else if (!currentPoster) {
                ctx.fillStyle = "#222"; ctx.fillRect(0, 0, size, size);
            }

            // C. OVERLAYS
            ctx.globalCompositeOperation = 'source-over';
            const drawOverlay = (img) => { if (img) ctx.drawImage(img, 0, 0, size, size); };
            
            drawOverlay(ASSETS.case.img);
            drawOverlay(ASSETS.shadow.img);
            drawOverlay(ASSETS.clips.img);
            drawOverlay(ASSETS.lights.img);
        }

        function calculateFit(img, zone) {
            const imgRatio = img.naturalWidth / img.naturalHeight;
            const zoneRatio = zone.w / zone.h;
            let newW, newH;

            if (imgRatio > zoneRatio) {
                newH = zone.h; newW = newH * imgRatio;
            } else {
                newW = zone.w; newH = newW / imgRatio;
            }
            
            const newX = zone.x - (newW - zone.w) / 2;
            const newY = zone.y - (newH - zone.h) / 2;

            return { x: newX, y: newY, w: newW, h: newH };
        }

        function handlePosterUpload(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        currentPoster = img;
                        log("Poster loaded. Rendering...", "status-ok");
                        render();
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        }

        function downloadCover() {
            try {
                const link = document.createElement('a');
                link.download = 'poster.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (e) {
                alert("Browser blocked auto-download.\nPlease Right-Click the image -> Save Image As.");
            }
        }

        function loadAsset(src) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = src;
            });
        }

        function log(msg, cls) {
            statusEl.textContent = msg;
            statusEl.className = "status-box " + cls;
        }
    </script>
</body>
</html>